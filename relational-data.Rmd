---
title: "13. Relational data"
output:
  html_document:
    toc: true
    toc_depth: 3
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(nycflights13)
# For 13.4.6 Exercises
library(maps)
```

### 13.2.1 Exercises

1.  Imagine you wanted to draw (approximately) the route each plane flies from
    its origin to its destination. What variables would you need? What tables
    would you need to combine?
    
From `flights`, you would need `origin` and `dest`. From `airports`, `lat`, `lon` (the locations of the airport), and maybe `alt` would be required. You would need to combine the `flights` and `airports` tables to get the origin airport and destination airport.

The `weather` table may also be helpful as wind speed, wind direction, and visibility may affect the route.

2.  I forgot to draw the relationship between `weather` and `airports`.
    What is the relationship and how should it appear in the diagram?
    
`weather` connects to `airports` via `origin` (the location). In the diagram, there should be an arrow pointing from `faa` in the `airports` table to `origin` in the `weather` table.

3.  `weather` only contains information for the origin (NYC) airports. If
    it contained weather records for all airports in the USA, what additional
    relation would it define with `flights`?
    
`year`, `month`, `day`, and `hour`.

4.  We know that some days of the year are "special", and fewer people than
    usual fly on them. How might you represent that data as a data frame?
    What would be the primary keys of that table? How would it connect to the
    existing tables?

You would have date and name variables. The primary key of this table would be date. It would match to `year`, `month`, and `day` in other tables such as `flights`.

### 13.3.1 Exercises

1.  Add a surrogate key to `flights`.

```{r}
flights %>% 
  arrange(year, month, day, sched_dep_time) %>% 
  mutate(flight_id = row_number())
```

2.  Identify the keys in the following datasets

    1.  `Lahman::Batting`,
    2.  `babynames::babynames`
    3.  `nasaweather::atmos`
    4.  `fueleconomy::vehicles`
    5.  `ggplot2::diamonds`
    
    (You might need to install some packages and read some documentation.)
    
`Lahman::Batting`:

The primary keys for `Lahman::Batting` are `playerID`, `yearID`, and `stint`.

```{r}
Lahman::Batting %>% 
  count(playerID, yearID, stint) %>% 
  filter(n > 1)
```

`playerID` is a foreign key (it is the primary key for `Lahman::Master`).

`babynames::babynames`:

The primary keys for `babynames::babynames` are `year`, `sex`, and `name`.

```{r}
babynames::babynames %>%
  group_by(year, sex, name) %>%
  filter(n() > 1)
```

`nasaweather::atmos`:

For `nasaweather:atmos`, the primary keys are `lat`, `long`, `year`, 
and `month`.

```{r}
nasaweather::atmos %>% 
  group_by(lat, long, year, month) %>% 
  filter(n() > 1)
```

`fueleconomy::vehicles`:

The primary key for `fueleconomy::vehicles` is `id`.

```{r}
fueleconomy::vehicles %>% 
  count(id) %>% 
  filter(n > 1)
```

`ggplot2::diamonds`:

`ggplot2::diamonds` does not appear to have a primary key.

```{r}
ggplot2::diamonds %>% 
  group_by(carat, cut, color, clarity, depth, table, price, x, y, z) %>% 
  filter(n() > 1) %>% 
  nrow()
```

3.  Draw a diagram illustrating the connections between the `Batting`,
    `Master`, and `Salaries` tables in the Lahman package. Draw another diagram
    that shows the relationship between `Master`, `Managers`, `AwardsManagers`.

    How would you characterise the relationship between the `Batting`,
    `Pitching`, and `Fielding` tables?
    
### 13.4.6 Exercises

1.  Compute the average delay by destination, then join on the `airports`
    data frame so you can show the spatial distribution of delays. Here's an
    easy way to draw a map of the United States:

    ```{r, eval = FALSE}
    airports %>%
      semi_join(flights, c("faa" = "dest")) %>%
      ggplot(aes(lon, lat)) +
        borders("state") +
        geom_point() +
        coord_quickmap()
    ```

    (Don't worry if you don't understand what `semi_join()` does --- you'll
    learn about it next.)

    You might want to use the `size` or `colour` of the points to display
    the average delay for each airport.
    
```{r}
dest_delay <- flights %>% 
  group_by(dest) %>% 
  summarise(avg_delay = mean(arr_delay, na.rm = TRUE))

dest_delay %>% 
  left_join(airports, c("dest" = "faa")) %>% 
  ggplot(aes(lon, lat)) +
    borders("state") +
    geom_point(aes(colour = avg_delay)) +
    coord_quickmap()
```

2.  Add the location of the origin _and_ destination (i.e. the `lat` and `lon`)
    to `flights`.
    
```{r}
flights %>% 
  left_join(airports, c("origin" = "faa")) %>% 
  left_join(airports, c("dest" = "faa")) %>% 
  rename(lat_origin = lat.x, lon_origin = lon.x) %>%
  rename(lat_dest = lat.y, lon_dest = lon.y) %>% 
  select(-contains("."))
```

3.  Is there a relationship between the age of a plane and its delays?

```{r}
planes_avg_delay <- planes %>% 
  select(tailnum, year) %>% 
  left_join(flights, "tailnum") %>% 
  group_by(tailnum, year.x) %>%
  rename(year = year.x) %>% 
  summarise(avg_delay = mean(arr_delay, na.rm = TRUE))

ggplot(planes_avg_delay, aes(year, avg_delay)) +
  geom_point() +
  geom_smooth()
```

It appears not.

4.  What weather conditions make it more likely to see a delay?

I think rain and low visibility would increase the likelihood of delay.

```{r}
flights_weather <- flights %>% 
  inner_join(weather, c("origin", "year", "month", "day", "hour"))

flights_weather %>% 
  group_by(visib) %>% 
  summarise(avg_delay = mean(dep_delay, na.rm = TRUE)) %>% 
  ggplot(aes(visib, avg_delay)) + 
    geom_point() +
    geom_line() +
    geom_smooth(method = lm, se = FALSE)
```

As visibility increases, the average delay decreases.

```{r}
flights_weather %>% 
  group_by(precip) %>% 
  summarise(avg_delay = mean(dep_delay, na.rm = TRUE)) %>% 
  ggplot(aes(precip, avg_delay)) + 
    geom_point() +
    geom_line() +
    geom_smooth(method = lm, se = FALSE)
```

The relationship between rainfall and average delay is less clear.

5.  What happened on June 13 2013? Display the spatial pattern of delays,
    and then use Google to cross-reference with the weather.
    
There were a large series of storms in the south-east.

    ```{r, eval = FALSE, include = FALSE}
    worst <- filter(flights, !is.na(dep_time), month == 6, day == 13)
    worst %>%
      group_by(dest) %>%
      summarise(delay = mean(arr_delay), n = n()) %>%
      filter(n > 5) %>%
      inner_join(airports, by = c("dest" = "faa")) %>%
      ggplot(aes(lon, lat)) +
        borders("state") +
        geom_point(aes(size = n, colour = delay)) +
        coord_quickmap()
    ```
    
```{r}
flights %>% 
  filter(month == 6, day == 13) %>% 
  group_by(hour) %>% 
  summarise(avg_delay = mean(dep_delay, na.rm = TRUE))
```

By mid-morning there were significant delays. This continued into the evening.

```{r}
flights %>% 
  filter(month == 6, day == 13) %>% 
  group_by(dest) %>% 
  summarise(avg_delay = mean(dep_delay, na.rm = TRUE)) %>% 
  inner_join(airports, by = c("dest" = "faa")) %>%
    ggplot(aes(lon, lat)) +
      borders("state") +
      geom_point(aes(colour = avg_delay, size = avg_delay)) +
      coord_quickmap()
```

### 13.5.1 Exercises

1.  What does it mean for a flight to have a missing `tailnum`? What do the
    tail numbers that don't have a matching record in `planes` have in common?
    (Hint: one variable explains ~90% of the problems.)
    
```{r}
flights %>% 
  anti_join(planes, by = "tailnum")
```

Many of the flights without a tail number in `planes` appear to be American Airlines (`AA`) or Envoy Air (`MQ`).
    
```{r}
flights %>% 
  anti_join(planes, by = "tailnum") %>% 
  group_by(carrier) %>% 
  summarise(count = n())
```

```{r}
flights %>% 
  anti_join(planes, by = "tailnum") %>% 
  nrow()
```

Specifically, about 90% of flights.

2.  Filter flights to only show flights with planes that have flown at least 100
    flights.
    
```{r}
flights_100 <- flights %>% 
  group_by(tailnum) %>% 
  count() %>% 
  filter(n >= 100 & tailnum != "NA") %>% 
  arrange(desc(n))

flights %>% 
  semi_join(flights_100, by = "tailnum")
```

3.  Combine `fueleconomy::vehicles` and `fueleconomy::common` to find only the
    records for the most common models.
    
```{r}
fueleconomy::vehicles %>% 
  semi_join(fueleconomy::common, by = c("make", "model"))

```

4.  Find the 48 hours (over the course of the whole year) that have the worst
    delays. Cross-reference it with the `weather` data. Can you see any
    patterns?
    
5.  What does `anti_join(flights, airports, by = c("dest" = "faa"))` tell you?
    What does `anti_join(airports, flights, by = c("faa" = "dest"))` tell you?
    
```{r}
anti_join(flights, airports, by = c("dest" = "faa"))
```

The destination of these flights is unknown (i.e., the airport does not appear in `airports`). They could be international flights.

```{r}
anti_join(airports, flights, by = c("faa" = "dest"))
```

These are the destination airports for all flights that departed NYC in 2013.

6.  You might expect that there's an implicit relationship between plane
    and airline, because each plane is flown by a single airline. Confirm
    or reject this hypothesis using the tools you've learned above.
    
```{r}
flights_carrier <- flights %>% 
  group_by(tailnum, carrier) %>% 
  count() %>% 
  arrange(tailnum)
flights_carrier

flights_carrier %>% 
  group_by(tailnum) %>% 
  count() %>% 
  filter(nn > 1)
```

There are a number of planes that have been flown by multiple airlines. However, the majority of planes have had a single airline.